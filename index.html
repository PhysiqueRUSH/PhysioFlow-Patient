<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1923">
<link rel="manifest" href="manifest.json">
<title>PhysioFlow ‚Äî R√©servation</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f2efe9;--bg2:#e8e4dc;--surface:#fff;--surface2:#faf9f6;
  --text:#1a1a2e;--text2:#6a6a7e;--text3:#8a8a9a;
  --accent:#2a7c6f;--accent2:#3bb5a0;--accentbg:rgba(42,124,111,.07);
  --border:#ccc8bf;--border2:#ddd8cf;
  --shadow:0 4px 16px rgba(0,0,0,.08);
  --radius:8px;--radiuslg:14px;--radiusxl:20px;
  --c0:#4a80c4;--c0bg:#dce7f5;
  --c1:#e07a3a;--c1bg:#fce8d8;
  --c2:#7b5bbf;--c2bg:#ece4f8;
  --c3:#c44a6a;--c3bg:#fce0e8;
  --c4:#3aad5c;--c4bg:#d8f2e0;
  --c5:#c4a030;--c5bg:#f8f2d8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}
input,select,textarea{font-family:inherit;color:var(--text);font-size:14px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100}
.logo{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:16px;color:var(--accent);letter-spacing:-.5px}
.logo b{color:var(--text)}
.logo-sub{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace}

.main{max-width:520px;margin:0 auto;padding:16px}

/* Steps */
.step{display:none;animation:fadeIn .3s ease}
.step.on{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

.card{background:var(--surface);border-radius:var(--radiuslg);padding:16px;margin-bottom:12px;border:1px solid var(--border2)}
.card h2{font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.card h3{font-size:13px;font-weight:600;margin:12px 0 6px;color:var(--text2)}

.btn{padding:10px 18px;border-radius:var(--radius);font-size:13px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:5px;transition:transform .1s}
.btn:active{transform:scale(.97)}
.bp{background:var(--accent);color:#fff}
.bs{background:var(--bg);border:1.5px solid var(--border)}
.bw{width:100%}
.bd{background:#e74c3c;color:#fff}

.fg{margin-bottom:12px}
.fg label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);outline:none}
.fg input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(42,124,111,.1)}
.fr{display:flex;gap:8px}
.fr .fg{flex:1}

/* Motif chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
.chip{padding:10px 16px;border-radius:var(--radiuslg);font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all .15s}
.chip:active{transform:scale(.96)}
.chip.sel{border-color:var(--text);transform:scale(1.03)}

/* Calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:10px}
.cal-hdr{text-align:center;font-size:11px;font-weight:700;color:var(--text2);padding:4px 0}
.cal-day{text-align:center;padding:10px 2px;border-radius:var(--radius);font-size:14px;font-weight:600;cursor:pointer;transition:all .12s}
.cal-day:active{transform:scale(.92)}
.cal-day.dis{opacity:.2;pointer-events:none}
.cal-day.sel{background:var(--accent);color:#fff}
.cal-day.today{outline:2px solid var(--accent);outline-offset:-2px}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.cal-nav .month{font-weight:700;font-size:15px}

/* Time slots */
.slots{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
.slot{padding:10px 16px;border-radius:var(--radius);font-size:14px;font-weight:600;font-family:'JetBrains Mono',monospace;background:var(--bg);border:1.5px solid var(--border);cursor:pointer;transition:all .12s}
.slot:active{transform:scale(.95)}
.slot.sel{background:var(--accent);color:#fff;border-color:var(--accent)}
.slot.taken{opacity:.25;pointer-events:none;text-decoration:line-through}

/* Summary */
.sum{background:var(--accentbg);border-radius:var(--radiuslg);padding:16px;margin-bottom:16px}
.sum .row{display:flex;justify-content:space-between;font-size:13px;padding:4px 0}
.sum .row b{color:var(--accent)}

/* Toast */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--text);color:#fff;padding:9px 18px;border-radius:var(--radius);font-size:12px;font-weight:500;z-index:300;opacity:0;transition:.25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.loader{text-align:center;padding:40px;color:var(--text2)}
.loader .spin{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite;margin-bottom:8px}
@keyframes sp{to{transform:rotate(360deg)}}

.success-icon{font-size:56px;text-align:center;margin:16px 0}
</style>
</head>
<body>
<div class="hdr">
  <div>
    <div class="logo"><b>Physio</b>Flow</div>
    <div class="logo-sub">R√©servation en ligne</div>
  </div>
</div>

<div class="main">
  <!-- STEP 0: Loading -->
  <div class="step on" id="s0">
    <div class="loader"><div class="spin"></div><div>Chargement des disponibilit√©s...</div></div>
  </div>

  <!-- STEP W: Welcome -->
  <div class="step" id="sW">
    <div class="card" style="text-align:center">
      <div style="font-size:48px;margin-bottom:8px">üëã</div>
      <h2 style="justify-content:center" id="welcomeTitle">Bienvenue</h2>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Que souhaitez-vous faire ?</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn bp bw" onclick="goStep(1)" style="padding:16px;font-size:15px">üìÖ Prendre un rendez-vous</button>
        <button class="btn bs bw" onclick="goMyBookings()" style="padding:16px;font-size:15px">üìã Voir / annuler mes rendez-vous</button>
      </div>
    </div>
    <div class="fg" style="margin-top:8px">
      <label>Votre num√©ro de t√©l√©phone (pour retrouver vos RDV)</label>
      <input type="tel" id="myPhone" placeholder="06 12 34 56 78" oninput="saveMyPhone()">
    </div>
  </div>

  <!-- STEP MB: My Bookings -->
  <div class="step" id="sMB">
    <div class="card">
      <h2>üìã Mes rendez-vous</h2>
      <div id="myBookingsList"></div>
    </div>
    <button class="btn bs bw" onclick="showStep('sW')">‚Üê Retour</button>
  </div>

  <!-- STEP 1: Choose Motif -->
  <div class="step" id="s1">
    <div class="card">
      <h2>üìã Choisir le type de s√©ance</h2>
      <div class="chips" id="motifChips"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn bs" onclick="showStep('sW')" style="flex:1">‚Üê Retour</button>
      <button class="btn bp" onclick="goStep(2)" id="btnS1" style="flex:2">Suivant ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2: Choose Date -->
  <div class="step" id="s2">
    <div class="card">
      <h2>üìÖ Choisir une date</h2>
      <div class="cal-nav">
        <button class="btn bs" onclick="calNav(-1)">‚Äπ</button>
        <div class="month" id="calMonth"></div>
        <button class="btn bs" onclick="calNav(1)">‚Ä∫</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn bs" onclick="goStep(1)" style="flex:1">‚Üê Retour</button>
      <button class="btn bp" onclick="goStep(3)" id="btnS2" style="flex:2">Suivant ‚Üí</button>
    </div>
  </div>

  <!-- STEP 3: Choose Time -->
  <div class="step" id="s3">
    <div class="card">
      <h2>üïê Choisir un horaire</h2>
      <div id="dateLabel" style="font-size:13px;color:var(--text2);margin-bottom:10px"></div>
      <div class="slots" id="timeSlots"></div>
      <div id="noSlots" style="display:none;text-align:center;padding:20px;color:var(--text2)">Aucun cr√©neau disponible pour cette date.</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn bs" onclick="goStep(2)" style="flex:1">‚Üê Retour</button>
      <button class="btn bp" onclick="goStep(4)" id="btnS3" style="flex:2">Suivant ‚Üí</button>
    </div>
  </div>

  <!-- STEP 4: Patient Info + Confirm -->
  <div class="step" id="s4">
    <div class="card">
      <h2>üë§ Vos informations</h2>
      <div class="fr">
        <div class="fg"><label>Nom</label><input id="pLast" placeholder="Votre nom"></div>
        <div class="fg"><label>Pr√©nom</label><input id="pFirst" placeholder="Votre pr√©nom"></div>
      </div>
      <div class="fg"><label>T√©l√©phone</label><input type="tel" id="pPhone" placeholder="06 12 34 56 78"></div>
      <div class="fg"><label>Remarque (optionnel)</label><textarea id="pNote" rows="2" placeholder="Pr√©cisions √©ventuelles..."></textarea></div>
    </div>

    <div class="sum" id="summary"></div>

    <div style="margin-bottom:12px">
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
        <input type="checkbox" id="smsReminder" checked style="width:18px;height:18px;accent-color:var(--accent)">
        üì© M'envoyer un SMS de rappel
      </label>
    </div>

    <div style="display:flex;gap:8px">
      <button class="btn bs" onclick="goStep(3)" style="flex:1">‚Üê Retour</button>
      <button class="btn bp" onclick="doBook()" id="btnBook" style="flex:2">‚úÖ Confirmer la r√©servation</button>
    </div>
  </div>

  <!-- STEP 5: Confirmation -->
  <div class="step" id="s5">
    <div class="card" style="text-align:center">
      <div class="success-icon">‚úÖ</div>
      <h2 style="justify-content:center">R√©servation confirm√©e !</h2>
      <div id="confirmDetails" style="font-size:13px;color:var(--text2);margin-top:8px"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn bp bw" onclick="resetAll()">Nouvelle r√©servation</button>
    </div>
    <div style="margin-top:12px">
      <button class="btn bs bw" onclick="showCancel()" style="color:var(--text2)">üö´ Annuler cette r√©servation</button>
    </div>
  </div>

  <!-- STEP 6: Cancel -->
  <div class="step" id="s6">
    <div class="card">
      <h2>üö´ Annuler votre r√©servation</h2>
      <div id="cancelInfo" style="font-size:13px;color:var(--text2);margin-bottom:12px"></div>
      <div class="fg"><label>Motif d'annulation</label>
        <select id="cancelReason">
          <option value="Emp√™chement personnel">Emp√™chement personnel</option>
          <option value="Probl√®me de sant√©">Probl√®me de sant√©</option>
          <option value="Changement d'horaire souhait√©">Changement d'horaire souhait√©</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
      <div class="fg" id="cancelOtherWrap" style="display:none">
        <label>Pr√©cisez</label><input id="cancelOtherInput" placeholder="Votre motif...">
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn bs" onclick="showStep('s5')" style="flex:1">‚Üê Retour</button>
      <button class="btn bd" onclick="doCancel()" style="flex:2">üö´ Confirmer l'annulation</button>
    </div>
  </div>

  <!-- Error state -->
  <div class="step" id="sErr">
    <div class="card" style="text-align:center">
      <div style="font-size:48px;margin-bottom:8px">‚ö†Ô∏è</div>
      <h2 style="justify-content:center">Service indisponible</h2>
      <div style="font-size:13px;color:var(--text2)">Impossible de charger les disponibilit√©s. R√©essayez plus tard.</div>
    </div>
    <button class="btn bs bw" onclick="location.reload()" style="margin-top:12px">üîÑ R√©essayer</button>
  </div>
</div>

<div class="toast" id="tst"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
<script>
/* ‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê */
const firebaseConfig = {
  apiKey: "AIzaSyDuV0ajg1O-Aw9CFFelwJlXy3_QDte7vPs",
  authDomain: "physioflow-7fcfd.firebaseapp.com",
  databaseURL: "https://physioflow-7fcfd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "physioflow-7fcfd",
  storageBucket: "physioflow-7fcfd.firebasestorage.app",
  messagingSenderId: "1065055310692",
  appId: "1:1065055310692:web:ae35f143f6aad77b8c6071"
};
firebase.initializeApp(firebaseConfig);
const FB=firebase.database();
const REF=FB.ref('physioflow');

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let CFG=null; // config from Pro: {days,motifs,openings,startH,endH,bookingRules}
let APTS=[]; // existing appointments
let SEL={motif:null,date:null,time:null};
let calView=new Date();

const CL_BG=['var(--c0bg)','var(--c1bg)','var(--c2bg)','var(--c3bg)','var(--c4bg)','var(--c5bg)'];
const CL_BD=['var(--c0)','var(--c1)','var(--c2)','var(--c3)','var(--c4)','var(--c5)'];
const MN=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const DS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const DL=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function dk(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function t2m(t){var p=t.split(':').map(Number);return p[0]*60+(p[1]||0)}
function m2t(m){return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0')}
function toast(m){var t=document.getElementById('tst');t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove('show')},2200)}

/* ‚ïê‚ïê‚ïê LOAD DATA FROM FIREBASE ‚ïê‚ïê‚ïê */
function loadData(){
  REF.child('config').once('value').then(function(snap){
    CFG=snap.val();
    if(!CFG||!CFG.motifs||!CFG.motifs.length){
      showStep('sErr');return;
    }
    if(!CFG.bookingRules)CFG.bookingRules={minHoursBefore:2,maxDaysAhead:60};
    return REF.child('appointments').once('value');
  }).then(function(snap){
    if(!snap)return;
    var d=snap.val();
    APTS=Array.isArray(d)?d:(d?Object.values(d):[]);
    /* Show welcome screen with proName */
    var proName=CFG.proName||'votre kin√©sith√©rapeute';
    document.getElementById('welcomeTitle').textContent='Bienvenue chez '+proName;
    /* Pre-fill phone from localStorage */
    var saved=localStorage.getItem('pf_patient');
    if(saved){
      try{
        var s=JSON.parse(saved);
        if(s.phone)document.getElementById('myPhone').value=s.phone;
      }catch(e){}
    }
    showStep('sW');
  }).catch(function(e){
    console.error(e);
    showStep('sErr');
  });

  /* Listen for real-time appointment changes and re-render */
  REF.child('appointments').on('value',function(snap){
    var d=snap.val();
    APTS=Array.isArray(d)?d:(d?Object.values(d):[]);
    /* Re-render current view if on slots or my bookings */
    var slotsStep=document.getElementById('s3');
    if(slotsStep && slotsStep.classList.contains('on')) renderSlots();
    var mbStep=document.getElementById('sMB');
    if(mbStep && mbStep.classList.contains('on')) goMyBookings();
  });
}

/* ‚ïê‚ïê‚ïê FCM FOR PATIENT NOTIFICATIONS ‚ïê‚ïê‚ïê */
var _patientFCM=null;
function initPatientFCM(){
  if(!('Notification' in window)||!('serviceWorker' in navigator))return;
  try{
    _patientFCM=firebase.messaging();
    _patientFCM.onMessage(function(payload){
      var n=payload.notification||{};
      toast('üîî '+(n.body||'Notification'));
      if(Notification.permission==='granted'){
        new Notification(n.title||'PhysioFlow',{body:n.body||'',icon:'PhysioFlowPatient.png'});
      }
    });
  }catch(e){console.warn('Patient FCM init error',e)}
}
function requestPatientNotif(patientId){
  if(!('Notification' in window)||!_patientFCM)return;
  if(Notification.permission==='denied')return;
  var doRegister=function(){
    navigator.serviceWorker.ready.then(function(reg){
      _patientFCM.getToken({
        vapidKey:'BHs6QaNOKQZvDDA_-Sgwk0raMLKJ1j41KxN9Qocl3p16kWsC5SDhCdGdGDpW6o-zCFScBaClxsaBMjhPt6IbLJM',
        serviceWorkerRegistration:reg
      }).then(function(token){
        if(token && patientId){
          REF.child('fcmTokens/patients/'+patientId).set(token);
        }
      }).catch(function(e){console.warn('Patient FCM token error',e)});
    });
  };
  if(Notification.permission==='granted'){doRegister();return;}
  Notification.requestPermission().then(function(p){
    if(p==='granted')doRegister();
  });
}
initPatientFCM();

function saveMyPhone(){
  var ph=(document.getElementById('myPhone').value||'').trim();
  try{
    var saved=JSON.parse(localStorage.getItem('pf_patient')||'{}');
    saved.phone=ph;
    localStorage.setItem('pf_patient',JSON.stringify(saved));
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê */
function showStep(id){
  document.querySelectorAll('.step').forEach(function(s){s.classList.remove('on')});
  document.getElementById(id).classList.add('on');
}
function goStep(n){
  if(n===1){
    showStep('s1');renderMotifs();return;
  }
  if(n===2){
    if(!SEL.motif){toast('Choisissez un type de s√©ance');return;}
    showStep('s2');renderCal();return;
  }
  if(n===3){
    if(!SEL.date){toast('Choisissez une date');return;}
    showStep('s3');renderSlots();return;
  }
  if(n===4){
    if(!SEL.time){toast('Choisissez un horaire');return;}
    /* Pre-fill from localStorage */
    try{
      var saved=JSON.parse(localStorage.getItem('pf_patient')||'{}');
      if(saved.lastName && !document.getElementById('pLast').value)document.getElementById('pLast').value=saved.lastName;
      if(saved.firstName && !document.getElementById('pFirst').value)document.getElementById('pFirst').value=saved.firstName;
      if(saved.phone && !document.getElementById('pPhone').value)document.getElementById('pPhone').value=saved.phone;
      if(!document.getElementById('pPhone').value){
        var myPh=document.getElementById('myPhone').value;
        if(myPh)document.getElementById('pPhone').value=myPh;
      }
    }catch(e){}
    showStep('s4');renderSummary();return;
  }
  showStep('s'+n);
}

/* ‚ïê‚ïê‚ïê MY BOOKINGS ‚ïê‚ïê‚ïê */
function goMyBookings(){
  var ph=(document.getElementById('myPhone').value||'').replace(/\s+/g,'').trim();
  if(!ph||ph.length<8){toast('Entrez d\'abord votre num√©ro de t√©l√©phone');return;}
  /* Find appointments matching this phone */
  var myApts=APTS.filter(function(a){
    if(a.cancelled)return false;
    if(!a.patientId)return false;
    var normPh=ph.replace(/\D/g,'');
    /* Match by phone stored in patientName field or check via source */
    return (a.patientPhone||'').replace(/\D/g,'').includes(normPh) ||
           normPh.includes((a.patientPhone||'').replace(/\D/g,''));
  });
  /* Also check by reading from firebase full data - look for patientId match */
  var todayK=dk(new Date());
  var futureApts=myApts.filter(function(a){return a.date>=todayK}).sort(function(a,b){return a.date<b.date?-1:(a.date>b.date?1:t2m(a.time)-t2m(b.time))});

  var box=document.getElementById('myBookingsList');
  if(!futureApts.length){
    box.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2)">Aucun rendez-vous trouv√© pour ce num√©ro.<br><br><div style="font-size:12px">Si vous avez r√©serv√© r√©cemment, le rendez-vous peut mettre quelques secondes √† appara√Ætre.</div></div>';
  } else {
    box.innerHTML=futureApts.map(function(a){
      var dt=new Date(a.date+'T00:00:00');
      var motif=CFG.motifs.find(function(m){return m.id===a.motifId});
      var isToday=a.date===todayK;
      return '<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:var(--radius);margin-bottom:6px">'+
        '<div style="flex:1"><div style="font-weight:600;font-size:13px">'+DL[dt.getDay()]+' '+dt.getDate()+' '+MN[dt.getMonth()]+(isToday?' (aujourd\'hui)':'')+' √† <b>'+a.time+'</b></div>'+
        '<div style="font-size:12px;color:var(--text2)">'+(motif?motif.label:'S√©ance')+'</div></div>'+
        '<button class="btn bd" style="font-size:11px;padding:6px 10px" onclick="cancelFromList(\''+a.id+'\')">üö´ Annuler</button></div>';
    }).join('');
  }
  showStep('sMB');
}

function cancelFromList(apId){
  lastBookingId=apId;
  var ap=APTS.find(function(a){return a.id===apId});
  if(!ap){toast('RDV introuvable');return;}
  SEL.date=ap.date;SEL.time=ap.time;
  SEL.motif=CFG.motifs.find(function(m){return m.id===ap.motifId})||{label:'S√©ance'};
  showCancel();
}

/* ‚ïê‚ïê‚ïê STEP 1: MOTIFS ‚ïê‚ïê‚ïê */
function renderMotifs(){
  var box=document.getElementById('motifChips');
  box.innerHTML=CFG.motifs.map(function(m,i){
    var ci=m.ci!==undefined?m.ci:i;
    var sel=SEL.motif&&SEL.motif.id===m.id;
    return '<div class="chip'+(sel?' sel':'')+'" data-mid="'+m.id+'" style="background:'+CL_BG[ci%6]+';border-color:'+(sel?'var(--text)':'transparent')+'">'+
      m.label+' <span style="font-size:11px;opacity:.6">('+m.duration+'min)</span></div>';
  }).join('');
  box.querySelectorAll('.chip').forEach(function(c){
    c.onclick=function(){
      var mid=c.dataset.mid;
      SEL.motif=CFG.motifs.find(function(m){return m.id===mid})||null;
      SEL.date=null;SEL.time=null;
      renderMotifs();
    };
  });
}

/* ‚ïê‚ïê‚ïê STEP 2: CALENDAR ‚ïê‚ïê‚ïê */
function calNav(dir){
  calView.setMonth(calView.getMonth()+dir);
  renderCal();
}
function renderCal(){
  var y=calView.getFullYear(),m=calView.getMonth();
  document.getElementById('calMonth').textContent=MN[m]+' '+y;
  var first=new Date(y,m,1);
  var start=(first.getDay()+6)%7; // monday first
  var dim=new Date(y,m+1,0).getDate();
  var today=new Date();today.setHours(0,0,0,0);
  var todayK=dk(today);

  var rules=CFG.bookingRules||{};
  var minH=rules.minHoursBefore||2;
  var maxD=rules.maxDaysAhead||60;
  var now=new Date();
  var minDate=new Date(now.getTime()+minH*3600000);
  var maxDate=new Date(now);maxDate.setDate(maxDate.getDate()+maxD);

  var h='';
  ['L','M','M','J','V','S','D'].forEach(function(d){h+='<div class="cal-hdr">'+d+'</div>'});
  for(var i=0;i<start;i++)h+='<div></div>';
  for(var d=1;d<=dim;d++){
    var dt=new Date(y,m,d);
    var k=dk(dt);
    var dow=dt.getDay();
    var ok=CFG.days.includes(dow);
    /* Check booking rules */
    var tooSoon=dt<new Date(minDate.getFullYear(),minDate.getMonth(),minDate.getDate());
    var tooLate=dt>maxDate;
    var past=dt<today;
    var dis=!ok||tooSoon||tooLate||past;
    var sel=SEL.date===k;
    var isToday=k===todayK;
    h+='<div class="cal-day'+(dis?' dis':'')+(sel?' sel':'')+(isToday?' today':'')+'" data-k="'+k+'">'+d+'</div>';
  }
  document.getElementById('calGrid').innerHTML=h;
  document.querySelectorAll('.cal-day:not(.dis)').forEach(function(el){
    el.onclick=function(){
      SEL.date=el.dataset.k;SEL.time=null;
      renderCal();
    };
  });
}

/* ‚ïê‚ïê‚ïê STEP 3: TIME SLOTS ‚ïê‚ïê‚ïê */
function renderSlots(){
  if(!SEL.motif||!SEL.date)return;
  var motif=SEL.motif;
  var maxSlots=motif.slots||1;
  var times=(motif.times||[]).filter(Boolean).slice().sort(function(a,b){return t2m(a)-t2m(b)});

  /* If no typical times defined, generate from openings */
  if(!times.length){
    var dt=new Date(SEL.date+'T00:00:00');
    var dow=dt.getDay();
    var ops=(CFG.openings||[]).filter(function(o){return o.day===dow});
    ops.forEach(function(o){
      var s=t2m(o.start),e=t2m(o.end);
      for(var m=s;m+motif.duration<=e;m+=motif.duration){
        times.push(m2t(m));
      }
    });
  }

  /* Check booking rules: filter out times too soon */
  var rules=CFG.bookingRules||{};
  var minH=rules.minHoursBefore||2;
  var now=new Date();
  var minTime=new Date(now.getTime()+minH*3600000);
  var selDate=new Date(SEL.date+'T00:00:00');

  /* Get existing appointments for this date and this motif */
  var dayApts=APTS.filter(function(a){return a.date===SEL.date&&!a.cancelled});

  var dateObj=new Date(SEL.date+'T00:00:00');
  document.getElementById('dateLabel').textContent=DL[dateObj.getDay()]+' '+dateObj.getDate()+' '+MN[dateObj.getMonth()]+' '+dateObj.getFullYear();

  var box=document.getElementById('timeSlots');
  var noSlots=document.getElementById('noSlots');

  if(!times.length){
    box.innerHTML='';noSlots.style.display='block';return;
  }
  noSlots.style.display='none';

  box.innerHTML=times.map(function(t){
    /* Count how many bookings exist at this exact time for this motif */
    var tm=t2m(t);
    var bookingsAtSlot=dayApts.filter(function(a){
      return a.motifId===motif.id && a.time===t;
    }).length;
    /* Check general overlap for other motifs (unless simultaneous allowed) */
    var generalOverlap=false;
    if(!motif.allowSimul){
      generalOverlap=dayApts.some(function(a){
        if(a.motifId===motif.id)return false;
        var as=t2m(a.time),ae=as+(a.duration||30);
        var be=tm+(motif.duration||30);
        return tm<ae && be>as;
      });
    } else {
      /* Only check overlap with motifs that are NOT the simulWith partner */
      generalOverlap=dayApts.some(function(a){
        if(a.motifId===motif.id)return false;
        if(a.motifId===motif.simulWith)return false; /* allowed simultaneous */
        var as=t2m(a.time),ae=as+(a.duration||30);
        var be=tm+(motif.duration||30);
        return tm<ae && be>as;
      });
    }
    var taken=bookingsAtSlot>=maxSlots || generalOverlap;
    /* Check if too soon */
    var slotDate=new Date(selDate);
    slotDate.setHours(Math.floor(tm/60),tm%60,0,0);
    var tooSoon=slotDate<minTime;
    var dis=taken||tooSoon;
    var sel=SEL.time===t;
    var remaining=maxSlots-bookingsAtSlot;
    var badge=(maxSlots>1 && !dis && remaining>0)?(' <span style="font-size:10px;opacity:.6">('+remaining+' place'+(remaining>1?'s':'')+')</span>'):'';
    return '<div class="slot'+(dis?' taken':'')+(sel?' sel':'')+'" data-t="'+t+'">'+t+badge+'</div>';
  }).join('');

  box.querySelectorAll('.slot:not(.taken)').forEach(function(el){
    el.onclick=function(){
      SEL.time=el.dataset.t;
      renderSlots();
    };
  });
}

/* ‚ïê‚ïê‚ïê STEP 4: SUMMARY ‚ïê‚ïê‚ïê */
function renderSummary(){
  if(!SEL.motif||!SEL.date||!SEL.time)return;
  var dt=new Date(SEL.date+'T00:00:00');
  var h='<div class="row"><span>S√©ance</span><b>'+SEL.motif.label+'</b></div>';
  h+='<div class="row"><span>Dur√©e</span><b>'+SEL.motif.duration+' min</b></div>';
  h+='<div class="row"><span>Date</span><b>'+DL[dt.getDay()]+' '+dt.getDate()+' '+MN[dt.getMonth()]+'</b></div>';
  h+='<div class="row"><span>Heure</span><b>'+SEL.time+'</b></div>';
  document.getElementById('summary').innerHTML=h;
}

/* ‚ïê‚ïê‚ïê BOOK ‚ïê‚ïê‚ïê */
function doBook(){
  var ln=(document.getElementById('pLast').value||'').trim();
  var fn=(document.getElementById('pFirst').value||'').trim();
  var ph=(document.getElementById('pPhone').value||'').trim();
  var note=(document.getElementById('pNote').value||'').trim();

  if(!ln||!fn){toast('Nom et pr√©nom requis');return;}
  if(!ph||ph.length<8){toast('T√©l√©phone requis');return;}

  if(!SEL.motif||!SEL.date||!SEL.time){toast('S√©lection incompl√®te');return;}

  /* Double-check slot is still free (respects multi-slots and simultan√©it√©) */
  var tm=t2m(SEL.time);
  var dur=SEL.motif.duration||30;
  var maxSlots=SEL.motif.slots||1;
  var dayApts=APTS.filter(function(a){return a.date===SEL.date&&!a.cancelled});
  /* Count same-motif bookings at exact same time */
  var sameSlotCount=dayApts.filter(function(a){
    return a.motifId===SEL.motif.id && a.time===SEL.time;
  }).length;
  /* Check general overlap (other motifs, unless simul allowed) */
  var generalOverlap=false;
  if(!SEL.motif.allowSimul){
    generalOverlap=dayApts.some(function(a){
      if(a.motifId===SEL.motif.id)return false;
      var as=t2m(a.time),ae=as+(a.duration||30);
      return tm<ae && (tm+dur)>as;
    });
  } else {
    generalOverlap=dayApts.some(function(a){
      if(a.motifId===SEL.motif.id)return false;
      if(a.motifId===SEL.motif.simulWith)return false;
      var as=t2m(a.time),ae=as+(a.duration||30);
      return tm<ae && (tm+dur)>as;
    });
  }
  var conflict=sameSlotCount>=maxSlots || generalOverlap;
  if(conflict){toast('Ce cr√©neau vient d\'√™tre pris. Choisissez un autre.');goStep(3);return;}

  var btn=document.getElementById('btnBook');
  btn.disabled=true;btn.textContent='‚è≥ Envoi...';

  /* Save patient info for next time */
  try{
    localStorage.setItem('pf_patient',JSON.stringify({lastName:ln,firstName:fn,phone:ph}));
  }catch(e){}

  var pid='pat_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
  var booking={
    id:'b_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7),
    motifId:SEL.motif.id,
    date:SEL.date,
    time:SEL.time,
    duration:dur,
    patientId:pid,
    patientLastName:ln,
    patientFirstName:fn,
    patientPhone:ph,
    patientNote:note,
    bookedAt:new Date().toISOString(),
    source:'patient'
  };

  REF.child('patientBookings').push(booking);
  /* Write to notifyPro queue for Cloud Function push notification */
  REF.child('notifyPro').push({
    type:'booking',
    patientName:ln+' '+fn,
    date:booking.date,
    time:booking.time,
    motifId:booking.motifId,
    createdAt:new Date().toISOString()
  });
  /* Also write directly to appointments for immediate sync with other patients */
  var aptEntry={
    id:booking.id,
    date:booking.date,
    time:booking.time,
    duration:booking.duration,
    motifId:booking.motifId,
    patientId:booking.patientId,
    patientName:ln+' '+fn,
    patientPhone:ph,
    cancelled:false,
    type:'rdv',
    source:'patient'
  };
  /* Append to appointments array */
  REF.child('appointments').once('value').then(function(snap){
    var arr=snap.val();
    if(!Array.isArray(arr))arr=arr?Object.values(arr):[];
    arr.push(aptEntry);
    return REF.child('appointments').set(arr);
  }).then(function(){
    btn.disabled=false;btn.textContent='‚úÖ Confirmer la r√©servation';
    lastBookingId=booking.id;
    /* Show confirmation */
    var dt=new Date(SEL.date+'T00:00:00');
    var proName=CFG.proName||'votre kin√©sith√©rapeute';
    var isToday=SEL.date===dk(new Date());
    var dateLabel=DL[dt.getDay()]+' '+dt.getDate()+' '+MN[dt.getMonth()]+(isToday?' (aujourd\'hui)':'');
    document.getElementById('confirmDetails').innerHTML=
      '<div style="margin:8px 0"><b>'+SEL.motif.label+'</b></div>'+
      '<div>'+dateLabel+' √† <b>'+SEL.time+'</b></div>'+
      '<div style="margin-top:4px">'+ln+' '+fn+'</div>'+
      '<div style="margin-top:12px;font-size:12px;color:var(--text3)">Rendez-vous pris avec '+proName+'.</div>';
    showStep('s5');
    /* Register patient for push notifications */
    requestPatientNotif(booking.patientId);
    /* SMS self-reminder */
    if(document.getElementById('smsReminder')&&document.getElementById('smsReminder').checked && ph){
      var msg='üìÖ Rappel RDV Kin√© :\n'+SEL.motif.label+'\n'+dateLabel+' √† '+SEL.time+'\nAvec '+proName+'\n\n(Pensez √† pr√©venir en cas d\'emp√™chement)';
      var uri='sms:'+encodeURIComponent(ph)+'?body='+encodeURIComponent(msg);
      setTimeout(function(){window.location.href=uri},600);
    }
  }).catch(function(e){
    console.error(e);
    btn.disabled=false;btn.textContent='‚úÖ Confirmer la r√©servation';
    toast('Erreur lors de la r√©servation. R√©essayez.');
  });
}

function resetAll(){
  SEL={motif:null,date:null,time:null};
  document.getElementById('pLast').value='';
  document.getElementById('pFirst').value='';
  document.getElementById('pPhone').value='';
  document.getElementById('pNote').value='';
  calView=new Date();
  lastBookingId=null;
  showStep('sW');
}

/* ‚ïê‚ïê‚ïê CANCEL ‚ïê‚ïê‚ïê */
var lastBookingId=null;

function showCancel(){
  if(!lastBookingId||!SEL.motif||!SEL.date||!SEL.time){toast('Aucune r√©servation √† annuler');return;}
  var dt=new Date(SEL.date+'T00:00:00');
  document.getElementById('cancelInfo').innerHTML=
    '<b>'+SEL.motif.label+'</b> ‚Äî '+DL[dt.getDay()]+' '+dt.getDate()+' '+MN[dt.getMonth()]+' √† <b>'+SEL.time+'</b>';
  showStep('s6');
  /* Toggle "Autre" field */
  document.getElementById('cancelReason').onchange=function(){
    document.getElementById('cancelOtherWrap').style.display=
      this.value==='Autre'?'block':'none';
  };
}

function doCancel(){
  if(!lastBookingId){toast('Aucune r√©servation √† annuler');return;}
  var reason=document.getElementById('cancelReason').value;
  if(reason==='Autre'){
    var v=(document.getElementById('cancelOtherInput').value||'').trim();
    if(v)reason=v;
  }
  /* Push cancellation notification for Pro */
  REF.child('patientCancellations').push({
    appointmentId:lastBookingId,
    reason:reason,
    cancelledAt:new Date().toISOString()
  });
  /* Write to notifyPro queue for Cloud Function push notification */
  REF.child('notifyPro').push({
    type:'cancel',
    appointmentId:lastBookingId,
    reason:reason,
    createdAt:new Date().toISOString()
  });
  /* Also mark cancelled directly in appointments for immediate sync */
  var cancelId=lastBookingId;
  REF.child('appointments').once('value').then(function(snap){
    var arr=snap.val();
    if(!Array.isArray(arr))arr=arr?Object.values(arr):[];
    for(var i=0;i<arr.length;i++){
      if(arr[i] && arr[i].id===cancelId){
        arr[i].cancelled=true;
        arr[i].cancelledBy='patient';
        arr[i].cancelReason=reason;
        break;
      }
    }
    return REF.child('appointments').set(arr);
  }).then(function(){
    toast('R√©servation annul√©e');
    lastBookingId=null;
    showStep('sW');
  }).catch(function(e){
    console.error(e);
    toast('Erreur, r√©essayez');
  });
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
loadData();
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});
</script>
</body>
</html>
